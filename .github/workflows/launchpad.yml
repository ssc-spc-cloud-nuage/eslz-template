name: launchpad

on:
  push:
    branches:
    - master
  pull_request:

env:
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  TF_CLI_ARGS_destroy: '-auto-approve -refresh=false'
  TFVARS_PATH: '/tf/caf/environments'

jobs:
  launchpad_deploy:
    name: launchpad_deploy
    runs-on: ubuntu-latest
    container:
      image: aztfmod/rover:2007.0108
      options: --user 0
    strategy:
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Login azure
        run: |
          az login --service-principal -u '${{ env.ARM_CLIENT_ID }}' -p '${{ env.ARM_CLIENT_SECRET }}' --tenant '${{ env.ARM_TENANT_ID }}'
          az account set --subscription ${{ env.ARM_SUBSCRIPTION_ID }}
      - name:  Setup context
        run: ln -s ${GITHUB_WORKSPACE} /tf/caf
      - name: Create launchpad
        run: |
          /tf/rover/rover.sh /tf/caf/L0_blueprint_launchpad/code apply \
            -launchpad \
            -env sample \
            -tfstate "L0_blueprint_launchpad_sample" \
            -var-file="/tf/caf/L0_blueprint_launchpad/environments/sample.tfvars"

  base_deploy:
    name: base_deploy
    needs: launchpad_deploy
    runs-on: ubuntu-latest
    container:
      image: aztfmod/rover:2007.0108
      options: --user 0
    strategy:
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Login azure
        run: |
          az login --service-principal -u '${{ env.ARM_CLIENT_ID }}' -p '${{ env.ARM_CLIENT_SECRET }}' --tenant '${{ env.ARM_TENANT_ID }}'
          az account set --subscription ${{ env.ARM_SUBSCRIPTION_ID }}
      - name:  Setup context
        run: ln -s ${GITHUB_WORKSPACE} /tf/caf
      - name: Create base
        run: |
          /tf/rover/rover.sh /tf/caf/L1_blueprint_base/code apply \
            -launchpad \
            -env sample \
            -tfstate "L1_blueprint_base_sample" \
            -var-file="/tf/caf/L1_blueprint_base/environments/sample.tfvars"

  base_destroy:
    name: base_destroy
    needs: base_deploy
    runs-on: ubuntu-latest
    if: always()
    strategy:
      fail-fast: false
    container:
      image: aztfmod/rover:2007.0108
      options: --user 0
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Login azure
        run: |
          az login --service-principal -u '${{ env.ARM_CLIENT_ID }}' -p '${{ env.ARM_CLIENT_SECRET }}' --tenant '${{ env.ARM_TENANT_ID }}'
          az account set --subscription ${{ env.ARM_SUBSCRIPTION_ID }}
      - name:  Setup context
        run: ln -s ${GITHUB_WORKSPACE} /tf/caf
      - name: Destroy base
        run: |
          /tf/rover/rover.sh /tf/caf/L1_blueprint_base/code destroy \
            -launchpad \
            -env sample \
            -tfstate "L1_blueprint_base_sample" \
            -var-file="/tf/caf/L1_blueprint_base/environments/sample.tfvars" \
            -auto-approve

  launchpad_destroy:
    name: launchpad_destroy
    needs: base_destroy
    runs-on: ubuntu-latest
    if: always()
    strategy:
      fail-fast: false
    container:
      image: aztfmod/rover:2007.0108
      options: --user 0
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Login azure
        run: |
          az login --service-principal -u '${{ env.ARM_CLIENT_ID }}' -p '${{ env.ARM_CLIENT_SECRET }}' --tenant '${{ env.ARM_TENANT_ID }}'
          az account set --subscription ${{ env.ARM_SUBSCRIPTION_ID }}
      - name:  Setup context
        run: ln -s ${GITHUB_WORKSPACE} /tf/caf
      - name: Destroy launchpad
        run: |
          /tf/rover/rover.sh /tf/caf/L0_blueprint_launchpad/code destroy \
            -launchpad \
            -env sample \
            -tfstate "L0_blueprint_launchpad_sample" \
            -var-file="/tf/caf/L0_blueprint_launchpad/environments/sample.tfvars" \
            -auto-approve
