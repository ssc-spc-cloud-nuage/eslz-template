name: launchpad

on:
  push:
    branches:
    - master
  pull_request:

env:
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  TF_CLI_ARGS_destroy: '-auto-approve -refresh=false'
  TFVARS_PATH: '/tf/caf/environments'

jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-latest

    container:
      image: aztfmod/rover:2007.0108
      options: --user 0

    strategy:
      fail-fast: false

    steps:
      - uses: actions/checkout@v2

      - name: Login azure
        run: |
          az login --service-principal -u '${{ env.ARM_CLIENT_ID }}' -p '${{ env.ARM_CLIENT_SECRET }}' --tenant '${{ env.ARM_TENANT_ID }}'
          az account set --subscription ${{ env.ARM_SUBSCRIPTION_ID }}

      - name:  Setup context
        run: |
          ln -s ${GITHUB_WORKSPACE} /tf/caf

      - name: Create launchpad
        run: |
          /tf/rover/rover.sh /tf/caf/L0_blueprint_launchpad/code apply \
            -launchpad \
            -env sample \
            -tfstate "L0_blueprint_launchpad_sample" \
            -var-file="/tf/caf/L0_blueprint_launchpad/environments/sample.tfvars"

      - name: Create base
        run: |
          /tf/rover/rover.sh /tf/caf/L1_blueprint_base/code apply \
            -launchpad \
            -env sample \
            -tfstate "L1_blueprint_base_sample" \
            -var-file="/tf/caf/L1_blueprint_base/environments/sample.tfvars"

      - name: Create project
        run: |
          /tf/rover/rover.sh /tf/caf/L2_blueprint_project/code apply \
            -launchpad \
            -env sample \
            -tfstate "L2_blueprint_project_sample" \
            -var-file="/tf/caf/L2_blueprint_project/environments/sample.tfvars"

  destroy:
    name: destroy
    runs-on: ubuntu-latest
    if: always()
    needs: deploy

    strategy:
      fail-fast: false

    container:
      image: aztfmod/rover:2007.0108
      options: --user 0

    steps:
      - uses: actions/checkout@v2

      - name: Login azure
        run: |
          az login --service-principal -u '${{ env.ARM_CLIENT_ID }}' -p '${{ env.ARM_CLIENT_SECRET }}' --tenant '${{ env.ARM_TENANT_ID }}'
          az account set --subscription ${{ env.ARM_SUBSCRIPTION_ID }}

      - name:  Setup context
        run: |
          ln -s ${GITHUB_WORKSPACE} /tf/caf

      - name: Destroy project
        run: |
          /tf/rover/rover.sh /tf/caf/L2_blueprint_project/code destroy \
            -launchpad \
            -env sample \
            -tfstate "L2_blueprint_project_sample" \
            -var-file="/tf/caf/L2_blueprint_project/environments/sample.tfvars" \
            -auto-approve

      - name: Destroy base
        run: |
          /tf/rover/rover.sh /tf/caf/L1_blueprint_base/code destroy \
            -launchpad \
            -env sample \
            -tfstate "L1_blueprint_base_sample" \
            -var-file="/tf/caf/L1_blueprint_base/environments/sample.tfvars" \
            -auto-approve

      - name: Destroy launchpad
        run: |
          /tf/rover/rover.sh /tf/caf/L0_blueprint_launchpad/code destroy \
            -launchpad \
            -env sample \
            -tfstate "L0_blueprint_launchpad_sample" \
            -var-file="/tf/caf/L0_blueprint_launchpad/environments/sample.tfvars" \
            -auto-approve
